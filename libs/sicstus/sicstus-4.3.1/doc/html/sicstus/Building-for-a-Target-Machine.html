<html lang="en">
<head>
<title>Building for a Target Machine - SICStus Prolog</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="SICStus Prolog">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Mixing-C-and-Prolog-Examples.html#Mixing-C-and-Prolog-Examples" title="Mixing C and Prolog Examples">
<link rel="prev" href="Train-Example.html#Train-Example" title="Train Example">
<link rel="next" href="Exceptions-from-C.html#Exceptions-from-C" title="Exceptions from C">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
<link href="texinfo.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="node">
<a name="Building-for-a-Target-Machine"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Exceptions-from-C.html#Exceptions-from-C">Exceptions from C</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Train-Example.html#Train-Example">Train Example</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Mixing-C-and-Prolog-Examples.html#Mixing-C-and-Prolog-Examples">Mixing C and Prolog Examples</a>
<hr>
</div>

<h4 class="subsection">6.8.2 Building for a Target Machine</h4>

<p>The following example shows how to build an application with a
dynamically loaded foreign resource in such a way that it can be
deployed into an arbitrary folder on a target system that does not have
SICStus installed. The example is run on Linux but it would be very
similar on other platforms.

   <p>The example consists of three source files, one toplevel file
(<samp><span class="file">main.pl</span></samp>) which in turn loads a module-file (<samp><span class="file">b.pl</span></samp>). The
latter also loads a foreign resource (<samp><span class="file">b.c</span></samp>).

   <p>The initial directory structure, and the contents of the source files
can be seen from the following transcript:
<pre class="example">     $ <kbd>find build/</kbd>
     build/
     build/myfiles
     build/myfiles/main.pl
     build/myfiles/b.pl
     build/myfiles/b.c
     $ <kbd>cat build/myfiles/main.pl</kbd>
     :- module(main, [main/0]).
     
     :- use_module(b,
                   [b_foreign/1]).
     
     main :-
       b_foreign(X),
       write(X), nl.
     
     user:runtime_entry(start) :-
       main.
     
     $ <kbd>cat build/myfiles/b.pl</kbd>
     :- module(b, [b_foreign/1]).
     
     foreign(b_foreign_c, b_foreign([-string])).
     
     foreign_resource(b, [
             b_foreign_c]).
     
     :- load_foreign_resource(b).
     
     $ <kbd>cat build/myfiles/b.c</kbd>
     #include &lt;sicstus/sicstus.h&gt;
     /* b_glue.h is generated by splfr from the foreign/[2,3] facts.
        Always include the glue header in your foreign resource code.
     */
     #include "b_glue.h"
     
     char const * SPCDECL b_foreign_c(void)
     {
       return "Hello World!";
     }
</pre>
   <p>The following transcript shows how the foreign resource and the SICStus
runtime executable is built:

<pre class="example">     $ <kbd>cd build/myfiles/</kbd>
     $ <kbd>splfr b.pl b.c</kbd>
     $ <kbd>cd ..</kbd>
     $ <kbd>sicstus --nologo</kbd>
     % optional step for embedding source info in saved-state.
     | ?- <kbd>set_prolog_flag(source_info, on).</kbd>
     yes
     % source_info
     | ?- <kbd>compile('myfiles/main.pl').</kbd>
     % compiling .../build/myfiles/main.pl...
     %  module main imported into user
     %  compiling .../build/myfiles/b.pl...
     %   module b imported into main
     %   loading foreign resource .../build/myfiles/b.so in module b
     %  compiled .../build/myfiles/b.pl in module b, 0 msec 3104 bytes
     % compiled .../build/myfiles/main.pl in module main, 0 msec 5344 bytes
     yes
     % source_info
     | ?- <kbd>save_program('main.sav').</kbd>
     % .../build/main.sav created in 20 msec
     yes
     % source_info
     | ?- <kbd>halt.</kbd>
     $ <kbd>spld '$SP_APP_DIR/main.sav' -o main.exe</kbd>
     Created "main.exe"
</pre>
   <p class="noindent">(instead of creating <samp><span class="file">main.exe</span></samp> you could use the generic runtime system
<samp><span class="file">sprt.exe</span></samp> provided as part of the installation (see <a href="Generic-Runtime-Systems.html#Generic-Runtime-Systems">Generic Runtime Systems</a>)).

   <p><strong>Please note</strong>: it is important that <samp><span class="file">main.sav</span></samp> be saved to a
folder that is the &ldquo;root&rdquo; of the folder tree. The folder in which the
saved-state is created (<samp><span class="file">.../build/</span></samp> above) is treated
specially by <code>save_program/[1,2]</code> and by <code>restore/1</code>. This
special handling ensures that <code>myfiles/b.so</code> will be found relative
to the location of <samp><span class="file">main.sav</span></samp> when <samp><span class="file">main.sav</span></samp> is restored on
the target system. See <a href="Saving.html#Saving">Saving</a> for details.

   <p>Next, the necessary runtime files must be copied from the SICStus
installation:

<pre class="example">     $ <kbd>mkdir -p sp-4.2.0/sicstus-4.2.0/bin</kbd>
     $ <kbd>cp /usr/local/sicstus4.2.0/lib/libsprt4-2-0.so sp-4.2.0/</kbd>
     $ <kbd>cp /usr/local/sicstus4.2.0/lib/sicstus-4.2.0/bin/sprt.sav \</kbd>
          <kbd>sp-4.2.0/sicstus-4.2.0/bin/sprt.sav</kbd>
</pre>
   <p>The resulting folder contents can be seen by running the <samp><span class="command">find</span></samp>
command:

<pre class="example">     $ <kbd>find . -print</kbd>
     .
     ./sp-4.2.0
     ./sp-4.2.0/libsprt4-2-0.so
     ./sp-4.2.0/sicstus-4.2.0
     ./sp-4.2.0/sicstus-4.2.0/bin
     ./sp-4.2.0/sicstus-4.2.0/bin/sprt.sav
     ./myfiles
     ./myfiles/b.so
     ./myfiles/main.pl
     ./myfiles/b.pl
     ./myfiles/b.c
     ./main.sav
     ./main.exe
</pre>
   <p>It is possible to run the program from its current location:

<pre class="example">     $ <kbd>./main.exe</kbd>
     Hello World!
</pre>
   <p>The folder <samp><span class="file">build/myfiles/</span></samp> contains some files that don't need to
be present on the target machine, i.e. the source files. The following
transcript shows how a new folder, <code>target/</code>, is created that
contains only the files that need to be present on the target system.

<pre class="example">     $ <kbd>cd ..</kbd>
     $ <kbd>mkdir target</kbd>
     $ <kbd>mkdir target/myfiles</kbd>
     $ <kbd>cp build/main.sav target</kbd>
     $ <kbd>cp build/main.exe target</kbd>
     $ <kbd>cp build/myfiles/b.so target/myfiles/</kbd>
     $ <kbd>cp -R build/sp-4.2.0 target</kbd>
     $ <kbd>find target/ -print</kbd>
     target/
     target/myfiles
     target/myfiles/b.so
     target/main.sav
     target/main.exe
     target/sp-4.2.0
     target/sp-4.2.0/sicstus-4.2.0
     target/sp-4.2.0/sicstus-4.2.0/bin
     target/sp-4.2.0/sicstus-4.2.0/bin/sprt.sav
     target/sp-4.2.0/libsprt4-2-0.so
     $ <kbd>target/main.exe</kbd>
     Hello World!
</pre>
   <p>Note that <samp><span class="file">target/myfiles/b.so</span></samp> was found since its location
relative the directory containing the saved-state (<samp><span class="file">main.sav</span></samp>) is
the same on the target system as on the build system.

   <p>The folder <samp><span class="file">target/</span></samp> can now be moved to some other system and
<samp><span class="file">target/main.exe</span></samp> will not depend on any files of the build
machine.

   <p>As a final example, the following transcripts show how the runtime
system can be debugged on the build machine. It is possible to do this
on the target system as well, if the necessary files are
made available. See <a href="Debugging-Runtime-Systems.html#Debugging-Runtime-Systems">Debugging Runtime Systems</a> for more information.

   <p>First, the development system files and the license file must be made
available:

<pre class="example">     $ <kbd>mkdir sp-4.2.0/sicstus-4.2.0/library</kbd>
     $ <kbd>cp /usr/local/sicstus4.2.0/lib/sicstus-4.2.0/library/SU_messages.po \</kbd>
          <kbd>sp-4.2.0/sicstus-4.2.0/library/</kbd>
     $ <kbd>cp /usr/local/sicstus4.2.0/lib/sicstus-4.2.0/bin/spds.sav \</kbd>
          <kbd>sp-4.2.0/sicstus-4.2.0/bin/</kbd>
     $ <kbd>cp /usr/local/sicstus4.2.0/lib/sicstus-4.2.0/library/license.pl \</kbd>
          <kbd>sp-4.2.0/sicstus-4.2.0/library/</kbd>
</pre>
   <p>As before, the resulting folder contents can be seen by running the
<samp><span class="command">find</span></samp> command:

<pre class="example">     $ <kbd>find . -print</kbd>
     .
     ./sp-4.2.0
     ./sp-4.2.0/libsprt4-2-0.so
     ./sp-4.2.0/sicstus-4.2.0
     ./sp-4.2.0/sicstus-4.2.0/library
     ./sp-4.2.0/sicstus-4.2.0/library/SU_messages.po
     ./sp-4.2.0/sicstus-4.2.0/library/license.pl
     ./sp-4.2.0/sicstus-4.2.0/bin
     ./sp-4.2.0/sicstus-4.2.0/bin/spds.sav
     ./sp-4.2.0/sicstus-4.2.0/bin/sprt.sav
     ./myfiles
     ./myfiles/b.so
     ./myfiles/main.pl
     ./myfiles/b.pl
     ./myfiles/b.c
     ./main.sav
     ./main.exe
     $
</pre>
   <p>To tell the runtime system to start a development system. you can set the
<samp><span class="env">SP_USE_DEVSYS</span></samp> environment variable as shown below. You could also
set <samp><span class="env">SP_ATTACH_SPIDER</span></samp> and debug in the SICStus IDE
(see <a href="Debugging-Runtime-Systems.html#Debugging-Runtime-Systems">Debugging Runtime Systems</a>).

<pre class="example">     $ <kbd>SP_USE_DEVSYS=yes</kbd>
     $ <kbd>export SP_USE_DEVSYS</kbd>
     $ <kbd>./main.exe</kbd>
     % The debugger will first creep -- showing everything (trace)
             1      1 Call: restore('$SP_APP_DIR/main.sav') ? &lt;RET&gt;
     % restoring .../build/main.sav...
     % .../build/main.sav restored in 10 msec 5600 bytes
             1      1 Exit: restore('$SP_APP_DIR/main.sav') ? &lt;RET&gt;
             2      1 Call: runtime_entry(start) ? &lt;RET&gt;
     in scope of a goal at line 12 in .../build/myfiles/main.pl
             3      2 Call: main:main ? &lt;RET&gt;
     in scope of a goal at line 7 in .../build/myfiles/main.pl
             4      3 Call: main:b_foreign(_2056) ? &lt;RET&gt;
     in scope of a goal at line 7 in .../build/myfiles/main.pl
             4      3 Exit: main:b_foreign('Hello World!') ? <kbd>v</kbd>
     Local variables (hit RET to return to debugger)
     X = 'Hello World!' ? &lt;RET&gt;
     in scope of a goal at line 7 in .../build/myfiles/main.pl
             4      3 Exit: main:b_foreign('Hello World!') ? <kbd>n</kbd>
     Hello World!
     $
</pre>
   <p><strong>Please note</strong>: source info is available, since we used
<code>set_prolog_flag(source_info, on)</code> before we compiled <samp><span class="file">main.pl</span></samp>
and created the saved-state <code>main.sav</code>.

<div class="logo">
<a href="http://sicstus.sics.se/">
<table><tr><td>&nbsp;</td></tr></table>
</a>
</div>
<div class="node">
<ul class="node">
<li><a href="index.html#Top">User's Manual</a>
<hr>
<li><a href="index.html#TOC">Table of Contents</a>
</ul>
</div>
<hr>
<a HREF="mailto:sicstus-support@sics.se?subject=Documentation%20feedback%20on%20html/sicstus/Building-for-a-Target-Machine.html&amp;body=Feedback%20on%20documentation%20node%20html/sicstus/Building-for-a-Target-Machine.html%20in%20User's%20Manual.">Send feedback on this subject.</a>
   </body></html>

