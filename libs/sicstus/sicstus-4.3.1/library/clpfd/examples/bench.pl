%% bench.pl
:- use_module(library(timeout)).
:- use_module(library(clpfd)).

files([queens,
       smm,
       five,
       eq10,
       eq20,
       partit,
       donald,
       crypta,
       alpha,
       magicseq,
       suudoku,
       mm,
       cars,
       bridge,
       photo,
       config,
       golomb,
       tsp,
       warehouse,
       knights,
       domqueens,
       router,
       pythagor,
       safe,
       party,
       magicsq,
       bibd,
       golf,
       torpedo,
       starpic,
       life,
       color,
       dna,
       hamilton,
       hamming,
       knapsack,
       protein,
       rehearsal,
       schur,
       steiner,
       primesums,
       skyscrapers,
       spiral,
       kakuro,
       tents,
       dominoes,
       almost_squares,
       bigdominoes,
       korf,
       partridge,
       squares,
       dsizes,
       shikaku,
       pentominoes,
       conway,
       floorplan,
       bacp,
       black_hole,
       open_stacks,
       wgcf,
       langford]).

benches(default,
	[heur_queens([ff],8),
	 heur_queens([ff],16),
	 heur_queens([ff],32),
	 heur_queens([ff],64),
	 heur_queens([ff],128),
	 smm([leftmost],value),
	 smm_ix([leftmost],value),
	 five_house([leftmost], value),
	 eq10([bisect,max], bound),
	 eq10_ix([bisect,max], bound),
	 eq20([bisect,max], bound),
	 eq20_ix([bisect,max], bound),
	 partit_global([ff],8),
	 partit_global([ff],16),
	 partit_global([ff],24),
	 partit_global([ff],32),
	 donald([ff,down], value),
	 donald_ix([ff,down], value),
	 crypta([ff,bisect], value),
	 crypta_ix([ff,bisect], value),
	 alpha([ffc,bisect], value),
	 alpha_ix([ffc,bisect], value),
	 magic(100,[down],value),
	 magic(100,[down],domain),
	 suudoku([ff],1,domain),
	 suudoku([ff],2,domain),
	 suudoku([ff],3,domain),
	 suudoku([ff],4,domain),
	 suudoku([ff],5,domain),
	 suudoku([ff],6,domain),
	 mm([6,5,6,3,2,3]),
	 cars(minslack,'26/82'),
	 bridge_p(big),
	 config(bb,[]),
	 config(restart,[]),
	 tsp(chip),
	 tsp(ilog),
	 warehouse(heur,p1),
	 knights(18),
	 domqueens(8),
	 \+route([ffc],72,1,27,174,1534),
	 photo(bb,[min],5,1,domain),
	 photo(bb,[min],7,1,domain),
	 photo(bb,[min],9,1,domain),
	 pythagoras([ff]),
	 safe([ff],value),
	 party([ff],domain),
	 magic_square([ff,bisect], 6, domain),
	 magic_square([ff,bisect], 7, domain),
	 bibd([rl,up,lex],10,90,27,3,6),
	 bibd([rl,up,lex],15,70,14,3,2),
	 bibd([rl,up,lex],12,88,22,3,4),
	 bibd([rl,up,lex],9,120,40,3,10),
	 bibd([rl,up,lex],10,120,36,3,8),
	 bibd([rl,up,lex],13,104,24,3,4),
	 golf(8,4,9,[min],bycolall,domain),
	 torpedo(id2794),
	 starpic(pinwheel),
	 starpic(doggie),
	 starpic(heart),
	 starpic(strange),
	 starpic(bunny),
	 starpic(spaceman),
	 starpic(crocodile),
	 starpic(non_unique),
	 starpic(difficult),
	 starpic(bigbunny),
	 starpic(dragonfly),
	 starpic(p56),
	 starpic(p99),
	 starpic(p200),
	 starpic(kabuki),
	 starpic(sheepdog),
	 starpic(warship),
	 still_life(plain_mirror,12,12,76),
	 \+coloring(static,5),
	 dna(plain,86),
	 hc(static),
	 hamming(10,3,64),
	 hamming(10,5,9),
	 knapsack(1023,1524),
	 protein(15),
	 rehearsal(concert),
	 rehearsal(film2),
	 rehearsal(film1),
	 golomb([],11,bound),
	 golomb([],12,bound),
	 steiner(dual,_,33,bound),
	 schur(122,5),
	 primesums(20),
	 skyscrapers(707),
	 spiral(a),
	 kakuro(hard),
	 tents(28),
	 dominoes(182),
	 almost_squares(16),
	 bigdominoes(16),
	 korf(20),
         partridge(8),
	 squares(id048),
	 dsizes(7),
         shikaku(giants8),
	 pentominoes(gabarit(5,4,3)),
	 conway,
	 floorplan(maculet1,in),
	 floorplan(maculet1,out),
	 bacp(12),
	 black_hole,
	 open_stacks(p10_10_1),
	 wgcf,
	 langford(3,10)
	]) :- !.
benches(Key,
	[heur_queens([ff],8),
	 heur_queens([ff],16),
	 heur_queens([ff],32),
	 heur_queens([ff],64),
	 heur_queens([ff],128),
	 smm([leftmost],Key),
	 smm_ix([leftmost],Key),
	 five_house([leftmost], Key),
	 eq10([bisect,max], Key),
	 eq10_ix([bisect,max], Key),
	 eq20([bisect,max], Key),
	 eq20_ix([bisect,max], Key),
	 partit_global([ff],8),
	 partit_global([ff],16),
	 partit_global([ff],24),
	 partit_global([ff],32),
	 donald([ff,down], Key),
	 donald_ix([ff,down], Key),
	 crypta([ff,bisect], Key),
	 crypta_ix([ff,bisect], Key),
	 alpha([ffc,bisect], Key),
	 alpha_ix([ffc,bisect], Key),
	 magic(100,[down],value),
	 magic(100,[down],domain),
	 suudoku([ff],1,Key),
	 suudoku([ff],2,Key),
	 suudoku([ff],3,Key),
	 suudoku([ff],4,Key),
	 suudoku([ff],5,Key),
	 suudoku([ff],6,Key),
	 mm([6,5,6,3,2,3]),
	 cars(minslack,'26/82'),
	 bridge_p(big),
	 config(bb,[]),
	 config(restart,[]),
	 tsp(chip),
	 tsp(ilog),
	 warehouse(heur,p1),
	 knights(18),
	 domqueens(8),
	 \+route([ffc],72,1,27,174,1534),
	 photo(bb,[min],5,1,Key),
	 photo(bb,[min],7,1,Key),
	 photo(bb,[min],9,1,Key),
	 pythagoras([ff]),
	 safe([ff],Key),
	 party([ff],Key),
	 magic_square([ff,bisect], 6, Key),
	 magic_square([ff,bisect], 7, Key),
	 bibd([rl,up,lex],10,90,27,3,6),
	 bibd([rl,up,lex],15,70,14,3,2),
	 bibd([rl,up,lex],12,88,22,3,4),
	 bibd([rl,up,lex],9,120,40,3,10),
	 bibd([rl,up,lex],10,120,36,3,8),
	 bibd([rl,up,lex],13,104,24,3,4),
	 golf(8,4,9,[min],bycolall,Key),
	 torpedo(id2794),
	 starpic(pinwheel),
	 starpic(doggie),
	 starpic(heart),
	 starpic(strange),
	 starpic(bunny),
	 starpic(spaceman),
	 starpic(crocodile),
	 starpic(non_unique),
	 starpic(difficult),
	 starpic(bigbunny),
	 starpic(dragonfly),
	 starpic(p56),
	 starpic(p99),
	 starpic(p200),
	 starpic(kabuki),
	 starpic(sheepdog),
	 starpic(warship),
	 still_life(plain_mirror,12,12,76),
	 \+coloring(static,5),
	 dna(plain,86),
	 hc(static),
	 hamming(10,3,64),
	 hamming(10,5,9),
	 knapsack(1023,1524),
	 protein(15),
	 rehearsal(concert),
	 rehearsal(film2),
	 rehearsal(film1),
	 golomb([],11,Key),
	 golomb([],12,Key),
	 steiner(dual,_,33,Key),
	 schur(122,5),
	 primesums(20),
	 skyscrapers(707),
	 spiral(a),
	 kakuro(hard),
	 tents(28),
	 dominoes(182),
	 almost_squares(16),
	 bigdominoes(16),
	 korf(20),
         partridge(8),
	 squares(id048),
	 dsizes(7),
         shikaku(giants8),
	 pentominoes(gabarit(5,4,3)),
	 conway,
	 floorplan(maculet1,in),
	 floorplan(maculet1,out),
	 bacp(12),
	 black_hole,
	 open_stacks(p10_10_1),
	 wgcf,
	 langford(3,10)
	]) :-
	key_not_value(Key, _KeyNotValue).

key_not_value(domain, domain).
key_not_value(bound, bound).
key_not_value(value, bound).

benches([]).
benches([Goal|Goals]) :-
	format(user_error, 'Calling goal: ~w\n',[Goal]),
	statistics(runtime,_),
	time_out(Goal, 300000, Result), !,
	(   Result==success ->
	    statistics(runtime,[_,T]),
	    format(user_error, 'Runtime: ~d\n',[T])
	;   format(user_error, 'Timed out after 5 minutes\n',[])
	),
	fd_statistics,
	nl(user_error),
	benches(Goals).

bench(Key) :-
	benches(Key, Benches),
	benches(Benches).

make([], _).
make([Goal|Goals], S) :-
	set_output(S),
	call(Goal), !,
	set_output(user),
	mkstats(Stats),
	portray_clause(goal_stats(Goal,Stats)),
	make(Goals, S).

make :-
	benches(default, Benches),
	open_null_stream(S),
	make(Benches, S),
	close(S).

mkstats([Resumptions,Entailments,Prunings,Backtracks,Constraints]) :-
	fd_statistics(resumptions, Resumptions),
	fd_statistics(entailments, Entailments),
	fd_statistics(prunings, Prunings),
	fd_statistics(backtracks, Backtracks),
	fd_statistics(constraints, Constraints).

:- files(Benches),
   ensure_loaded(Benches).

